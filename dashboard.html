<!DOCTYPE html>
<html lang="en" class="dark-theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal Dashboard</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* ==========================================
           MODERN THEME VARIABLES - Enhanced Design
           ========================================== */
        :root {
            /* Primary Colors */
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --secondary-color: #8b5cf6;
            --accent-color: #06b6d4;
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-tertiary: #64748b;
            
            /* Gradient & Effects */
            --gradient-1: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #06b6d4 100%);
            --gradient-2: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --gradient-card: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 40px rgba(99, 102, 241, 0.3);
            
            /* Status Colors */
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --info: #06b6d4;
            
            /* Calendar specific colors */
            --calendar-win-bg: rgba(16, 185, 129, 0.15);
            --calendar-win-border: rgba(16, 185, 129, 0.3);
            --calendar-loss-bg: rgba(239, 68, 68, 0.15);
            --calendar-loss-border: rgba(239, 68, 68, 0.3);
            --calendar-neutral-bg: rgba(255, 255, 255, 0.03);
            
            --transition-speed: 0.3s;
        }

        .light-theme {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e9ecef;
            --bg-hover: #dee2e6;
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-tertiary: #6c757d;
            --border-color: #dee2e6;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            
            --calendar-win-bg: rgba(16, 185, 129, 0.2);
            --calendar-win-border: rgba(16, 185, 129, 0.4);
            --calendar-loss-bg: rgba(239, 68, 68, 0.2);
            --calendar-loss-border: rgba(239, 68, 68, 0.4);
            --calendar-neutral-bg: rgba(0, 0, 0, 0.03);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background: var(--dark-bg);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            transition: all var(--transition-speed);
        }

        /* Loading Screen - Modernized */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            transition: opacity 0.5s;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid var(--glass-bg);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: var(--shadow-glow);
        }

        .loading-text {
            margin-top: 20px;
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 500;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Layout */
        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar - Enhanced Glassmorphism */
        .sidebar {
            width: 280px;
            background: var(--card-bg);
            padding: 1.5rem;
            position: fixed;
            height: 100vh;
            transition: all var(--transition-speed);
            z-index: 100;
            box-shadow: var(--shadow-lg);
            border-right: 1px solid var(--glass-border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
            margin-bottom: 2rem;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.02);
        }

        .logo-icon {
            width: 45px;
            height: 45px;
            background: var(--gradient-1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            box-shadow: var(--shadow-glow);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.4); }
            50% { box-shadow: 0 0 40px rgba(99, 102, 241, 0.6); }
        }

        .logo span {
            font-size: 1.4rem;
            font-weight: 800;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-links {
            list-style: none;
            margin-top: 1rem;
        }

        .nav-links li {
            position: relative;
            padding: 1rem 1.2rem;
            margin: 0.5rem 0;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all var(--transition-speed);
            color: var(--text-secondary);
            border: 1px solid transparent;
        }

        .nav-links li:hover {
            background: var(--glass-bg);
            color: var(--text-primary);
            border-color: var(--glass-border);
            transform: translateX(5px);
        }

        .nav-links li.active {
            background: var(--gradient-1);
            color: white;
            box-shadow: var(--shadow-glow);
            border-color: transparent;
        }

        .nav-links li i {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
            transition: all var(--transition-speed);
        }

        .nav-links li.active i {
            transform: scale(1.1);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
        }

        /* Header - Enhanced */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.2rem 1.5rem;
            background: var(--card-bg);
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
            position: relative;
            z-index: 50;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: var(--glass-bg);
            padding: 0.8rem 1.2rem;
            border-radius: 12px;
            width: 320px;
            border: 1px solid var(--glass-border);
            transition: all var(--transition-speed);
        }

        .search-bar:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .search-bar input {
            background: none;
            border: none;
            color: var(--text-primary);
            margin-left: 1rem;
            width: 100%;
            outline: none;
            font-size: 0.95rem;
        }

        .search-bar input::placeholder {
            color: var(--text-tertiary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        /* App Switcher - Enhanced */
        .app-switcher {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.5rem 1rem;
            background: var(--glass-bg);
            border-radius: 50px;
            border: 1px solid var(--glass-border);
        }

        .app-switcher span {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all var(--transition-speed);
        }

        .app-switcher span.active {
            color: var(--primary-color);
        }

        .switch-btn {
            width: 50px;
            height: 26px;
            background: var(--glass-bg);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            border: 2px solid var(--primary-color);
            transition: all var(--transition-speed);
        }

        .switch-btn::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: var(--primary-color);
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all var(--transition-speed);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
        }

        .switch-btn.budget::after {
            left: 26px;
        }

        /* Profile - FIXED Z-INDEX */
        .profile {
            position: relative;
            z-index: 1000;
        }

        .profile-trigger {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.5rem 1rem;
            background: var(--glass-bg);
            border-radius: 12px;
            cursor: pointer;
            transition: all var(--transition-speed);
            border: 1px solid var(--glass-border);
        }

        .profile-trigger:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-glow);
        }

        .profile-avatar {
            width: 38px;
            height: 38px;
            background: var(--gradient-1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .profile-info {
            display: flex;
            flex-direction: column;
        }

        .profile-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .profile-role {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* FIXED: Profile Dropdown with highest z-index */
        .profile-dropdown {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            width: 280px;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
            border: 1px solid var(--glass-border);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 99999 !important;
            backdrop-filter: blur(20px);
            overflow: hidden;
        }

        .profile-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-header {
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            background: var(--gradient-1);
        }

        .header-avatar {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .header-info h4 {
            margin: 0;
            font-size: 1rem;
            color: white;
        }

        .header-info span {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .dropdown-divider {
            height: 1px;
            background: var(--glass-border);
            margin: 0.5rem 0;
        }

        .dropdown-menu {
            list-style: none;
            padding: 0.5rem;
        }

        .dropdown-menu li {
            padding: 0.9rem 1rem;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            cursor: pointer;
            transition: all var(--transition-speed);
            color: var(--text-secondary);
        }

        .dropdown-menu li:hover {
            background: var(--glass-bg);
            color: var(--text-primary);
            transform: translateX(5px);
        }

        .dropdown-menu li i {
            width: 20px;
            color: var(--primary-color);
        }

        .dropdown-menu li.logout {
            color: var(--danger);
        }

        .dropdown-menu li.logout i {
            color: var(--danger);
        }

        /* Language Selector in Dropdown */
        .lang-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: auto;
            padding: 0.25rem 0.75rem;
            background: var(--glass-bg);
            border-radius: 20px;
            font-size: 0.8rem;
            border: 1px solid var(--glass-border);
        }

        .lang-option.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Content Sections */
        .content-section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Enhanced Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
            z-index: 1;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            transition: all var(--transition-speed);
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-1);
            opacity: 0;
            transition: opacity var(--transition-speed);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            background: var(--glass-bg);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--primary-color);
            border: 1px solid var(--glass-border);
            transition: all var(--transition-speed);
        }

        .stat-card:hover .stat-icon {
            background: var(--gradient-1);
            color: white;
            border-color: transparent;
            box-shadow: var(--shadow-glow);
        }

        .stat-details h3 {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .stat-details p {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.3rem;
            color: var(--text-primary);
        }

        .trend {
            font-size: 0.85rem;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .trend.positive {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .trend.negative {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        /* Charts - Enhanced Cards */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-speed);
        }

        .chart-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary-color);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chart-header h2, .chart-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .revenue-filter {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 0.6rem 2.5rem 0.6rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236366f1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            transition: all var(--transition-speed);
        }

        .revenue-filter:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Trade History - Enhanced */
        .trade-history-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
            transition: all var(--transition-speed);
        }

        .trade-history-card:hover {
            border-color: var(--primary-color);
        }

        .trade-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .trade-history-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Enhanced Button */
        .btn-add-trade {
            background: var(--gradient-1);
            color: white;
            border: none;
            padding: 0.9rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all var(--transition-speed);
            box-shadow: var(--shadow-glow);
            position: relative;
            overflow: hidden;
        }

        .btn-add-trade::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .btn-add-trade:hover::before {
            left: 100%;
        }

        .btn-add-trade:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.4);
        }

        .trade-table-container {
            overflow-x: auto;
        }

        .trade-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .trade-table th {
            text-align: left;
            padding: 1rem;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            border-bottom: 1px solid var(--glass-border);
            white-space: nowrap;
        }

        .trade-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--glass-border);
            color: var(--text-primary);
            vertical-align: middle;
        }

        .trade-table tr:hover {
            background: var(--glass-bg);
        }

        .badge-result {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-win { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .badge-loss { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .badge-breakeven { background: rgba(245, 158, 11, 0.15); color: var(--warning); }

        .badge-side {
            padding: 0.3rem 0.8rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .badge-buy { background: rgba(99, 102, 241, 0.15); color: var(--primary-color); }
        .badge-sell { background: rgba(239, 68, 68, 0.15); color: var(--danger); }

        .pnl-positive { color: var(--success); font-weight: 700; }
        .pnl-negative { color: var(--danger); font-weight: 700; }

        .action-btns {
            display: flex;
            gap: 0.5rem;
        }

        .btn-action {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-edit {
            background: rgba(99, 102, 241, 0.15);
            color: var(--primary-color);
        }

        .btn-edit:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .btn-delete {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .btn-delete:hover {
            background: var(--danger);
            color: white;
            transform: translateY(-2px);
        }

        /* Calendar - Enhanced */
        .calendar-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-lg);
            margin-top: 2rem;
            transition: all var(--transition-speed);
        }

        .calendar-card:hover {
            border-color: var(--primary-color);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .calendar-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .month-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: var(--glass-bg);
            padding: 0.5rem 1rem;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
        }

        .month-nav button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .month-nav button:hover {
            background: var(--glass-bg);
            color: var(--text-primary);
        }

        .month-nav span {
            font-weight: 600;
            min-width: 150px;
            text-align: center;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .day-header {
            text-align: center;
            padding: 1rem 0.5rem;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            background: var(--calendar-neutral-bg);
            border-radius: 12px;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            position: relative;
            min-height: 80px;
            display: flex;
            flex-direction: column;
        }

        .calendar-day:hover {
            transform: translateY(-2px);
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .calendar-day.other-month {
            opacity: 0.3;
            cursor: default;
        }

        .calendar-day.other-month:hover {
            transform: none;
            border-color: transparent;
            box-shadow: none;
        }

        .calendar-day.today {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
        }

        .calendar-day.win-day {
            background: var(--calendar-win-bg);
            border: 1px solid var(--calendar-win-border);
        }

        .calendar-day.win-day:hover {
            background: rgba(16, 185, 129, 0.25);
            border-color: rgba(16, 185, 129, 0.5);
        }

        .calendar-day.loss-day {
            background: var(--calendar-loss-bg);
            border: 1px solid var(--calendar-loss-border);
        }

        .calendar-day.loss-day:hover {
            background: rgba(239, 68, 68, 0.25);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .day-number {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
            color: var(--text-primary);
        }

        .day-pnl {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 0.75rem;
            margin-top: auto;
        }

        .day-pnl-win { color: var(--success); font-weight: 600; }
        .day-pnl-loss { color: var(--danger); font-weight: 600; }

        .day-net {
            font-size: 0.8rem;
            font-weight: 700;
            margin-top: 2px;
            padding-top: 2px;
            border-top: 1px solid var(--glass-border);
        }

        .day-net.positive { color: var(--success); }
        .day-net.negative { color: var(--danger); }

        /* Modals - Enhanced */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 20px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            background: var(--gradient-1);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .btn-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            transition: all 0.2s;
        }

        .btn-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 2rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.9rem;
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-group select option {
        background: var(--card-bg);
            color: var(--text-primary);
            padding: 0.5rem;
        }

        /* Helper text untuk input */
        .form-group small {
            color: var(--text-tertiary);
            font-size: 0.75rem;
            margin-top: 0.3rem;
            display: block;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            background: var(--glass-bg);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            border-top: 1px solid var(--glass-border);
        }

        .btn-cancel {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--glass-border);
            padding: 0.9rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-cancel:hover {
            background: var(--glass-bg);
            color: var(--text-primary);
        }

        .btn-save {
            background: var(--gradient-1);
            color: white;
            border: none;
            padding: 0.9rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            box-shadow: var(--shadow-glow);
            position: relative;
            overflow: hidden;
        }

        .btn-save::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .btn-save:hover::before {
            left: 100%;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.4);
        }

        /* Day Trades Modal */
        .day-transactions-modal {
            max-width: 500px;
        }

        .day-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .day-summary-item {
            background: var(--glass-bg);
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--glass-border);
        }

        .day-summary-item.win { border-left: 4px solid var(--success); }
        .day-summary-item.loss { border-left: 4px solid var(--danger); }

        .day-summary-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.3rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .day-summary-amount {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .day-summary-item.win .day-summary-amount { color: var(--success); }
        .day-summary-item.loss .day-summary-amount { color: var(--danger); }

        .trades-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .trade-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--glass-bg);
            border-radius: 12px;
            margin-bottom: 0.8rem;
            border: 1px solid var(--glass-border);
            transition: all 0.2s;
        }

        .trade-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .trade-item-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: white;
            flex-shrink: 0;
        }

        .trade-item-icon.win { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .trade-item-icon.loss { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .trade-item-icon.breakeven { background: rgba(245, 158, 11, 0.2); color: var(--warning); }

        .trade-item-details { flex: 1; }
        .trade-item-symbol { font-weight: 600; color: var(--text-primary); margin-bottom: 0.2rem; }
        .trade-item-meta { font-size: 0.8rem; color: var(--text-secondary); }

        .trade-item-amount { text-align: right; }
        .trade-item-amount .amount { font-weight: 700; font-size: 1rem; }
        .trade-item-amount .amount.win { color: var(--success); }
        .trade-item-amount .amount.loss { color: var(--danger); }
        .trade-item-amount .amount.breakeven { color: var(--warning); }

        .no-trades {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .no-trades i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            opacity: 0.5;
            color: var(--primary-color);
        }

        .empty-state h3 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        /* Symbol Stats */
        .symbol-stats { display: flex; flex-direction: column; gap: 1rem; }

        .symbol-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--glass-bg);
            border-radius: 12px;
            transition: all 0.2s;
            border: 1px solid var(--glass-border);
        }

        .symbol-item:hover {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--primary-color);
        }

        .symbol-rank {
            width: 35px;
            height: 35px;
            background: var(--gradient-1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            color: white;
            box-shadow: var(--shadow-glow);
        }

        .symbol-info { flex: 1; }
        .symbol-name { font-weight: 600; color: var(--text-primary); margin-bottom: 0.2rem; }
        .symbol-count { font-size: 0.8rem; color: var(--text-secondary); }

        .symbol-bar {
            width: 100px;
            height: 6px;
            background: var(--glass-bg);
            border-radius: 3px;
            overflow: hidden;
        }

        .symbol-progress {
            height: 100%;
            background: var(--gradient-1);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* Analytics Grid */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .analytics-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-speed);
        }

        .analytics-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-3px);
        }

        .analytics-card h3 {
            margin-bottom: 1rem;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .analytics-metrics {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
        }

        .metric-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--glass-border);
            text-align: center;
            transition: all var(--transition-speed);
        }

        .metric-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
        }

        .metric-card i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
            transition: all var(--transition-speed);
        }

        .metric-card:hover i {
            transform: scale(1.1);
            color: var(--accent-color);
        }

        .metric-info h3 {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .metric-info .counter {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Projects/Goals */
        .projects-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .btn-add-project {
            background: var(--gradient-1);
            color: white;
            border: none;
            padding: 0.9rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all var(--transition-speed);
            box-shadow: var(--shadow-glow);
            position: relative;
            overflow: hidden;
        }

        .btn-add-project::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .btn-add-project:hover::before {
            left: 100%;
        }

        .btn-add-project:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.4);
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .project-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-speed);
        }

        .project-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .project-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .status {
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status.active { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .status.pending { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .status.completed { background: rgba(6, 182, 212, 0.15); color: var(--info); }

        .project-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .project-targets { margin-top: 1rem; }

        .target-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.8rem;
            background: var(--glass-bg);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .target-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--glass-border);
        }

        .target-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            border: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .target-checkbox.checked {
            background: var(--primary-color);
            color: white;
        }

        .target-text { flex: 1; font-size: 0.9rem; color: var(--text-primary); }
        .target-text.completed { text-decoration: line-through; color: var(--text-tertiary); }

        .project-meta {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-progress { display: flex; align-items: center; gap: 1rem; }

        .progress-bar {
            width: 120px;
            height: 8px;
            background: var(--glass-bg);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: var(--gradient-1);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Settings - Enhanced with Language */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .settings-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-speed);
        }

        .settings-card:hover {
            border-color: var(--primary-color);
        }

        .settings-card h3 {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary);
        }

        .setting-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.2rem 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .setting-option:last-child { border-bottom: none; }

        .setting-info h4 {
            font-size: 1rem;
            margin-bottom: 0.3rem;
            color: var(--text-primary);
        }

        .setting-info p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Language Selector */
        .lang-selector {
            display: flex;
            gap: 0.5rem;
            background: var(--glass-bg);
            padding: 0.25rem;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
        }

        .lang-btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .lang-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .lang-btn:hover:not(.active) {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        /* Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--glass-bg);
            transition: .4s;
            border-radius: 34px;
            border: 1px solid var(--glass-border);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: var(--text-primary);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* Theme Switch */
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 22px;
            margin-left: auto;
        }

        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--glass-bg);
            transition: .4s;
            border-radius: 34px;
            border: 1px solid var(--glass-border);
        }

        .switch-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: var(--text-primary);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .switch-slider {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        input:checked + .switch-slider:before {
            transform: translateX(22px);
        }

        /* Notifications */
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 99999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .custom-notification {
            background: var(--card-bg);
            border-left: 4px solid var(--primary-color);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideIn 0.3s ease;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
        }

        .custom-notification.success { border-color: var(--success); }
        .custom-notification.error { border-color: var(--danger); }
        .custom-notification.warning { border-color: var(--warning); }

        .custom-notification i { font-size: 1.3rem; }
        .custom-notification.success i { color: var(--success); }
        .custom-notification.error i { color: var(--danger); }
        .custom-notification.warning i { color: var(--warning); }

        .notification-content { flex: 1; }
        .notification-content p {
            margin: 0;
            color: var(--text-primary);
            font-weight: 500;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 80px;
                padding: 1rem;
            }
            
            .sidebar span, .logo span { display: none; }
            
            .main-content { margin-left: 80px; }
            
            .analytics-grid { grid-template-columns: 1fr; }
            .analytics-metrics { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .charts-container { grid-template-columns: 1fr; }
            .search-bar { width: 200px; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track { background: var(--card-bg); }
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover { background: var(--primary-dark); }

        /* Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loader"></div>
        <div class="loading-text" data-i18n="loading">Loading Trading Journal...</div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="logo" onclick="window.location.href='index.html'">
                <div class="logo-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <span>TradeJournal</span>
            </div>
            <ul class="nav-links">
                <li class="active" data-section="dashboard" data-content="dashboard-content">
                    <i class="fas fa-home"></i>
                    <span data-i18n="dashboard">Dashboard</span>
                </li>
                <li data-section="analytics" data-content="analytics-content">
                    <i class="fas fa-chart-pie"></i>
                    <span data-i18n="analytics">Analytics</span>
                </li>
                <li data-section="projects" data-content="projects-content">
                    <i class="fas fa-bullseye"></i>
                    <span data-i18n="goals">Targets</span>
                </li>
                <li data-section="settings" data-content="settings-content">
                    <i class="fas fa-cog"></i>
                    <span data-i18n="settings">Settings</span>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header>
                <div class="header-left">
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" data-i18n-placeholder="searchPlaceholder" placeholder="Search trades or symbols...">
                    </div>
                </div>
                <div class="header-right">
                    <div class="app-switcher">
                        <span data-i18n="trading">Trading</span>
                        <div class="switch-btn" onclick="switchApp()"></div>
                        <span data-i18n="budget">Budget</span>
                    </div>

                    <div class="profile">
                        <div class="profile-trigger" onclick="toggleProfile()">
                            <div class="profile-avatar" id="headerAvatar">TJ</div>
                            <div class="profile-info">
                                <span class="profile-name" id="headerName">Trader</span>
                                <span class="profile-role" data-i18n="active">Active</span>
                            </div>
                            <i class="fas fa-chevron-down"></i>
                        </div>

                        <div class="profile-dropdown" id="profileDropdown">
                            <div class="dropdown-header">
                                <div class="header-avatar" id="dropdownAvatar">TJ</div>
                                <div class="header-info">
                                    <h4 id="dropdownName">Trading Journal</h4>
                                    <span id="dropdownEmail">trader@journal.com</span>
                                </div>
                            </div>
                            <div class="dropdown-divider"></div>
                            <ul class="dropdown-menu">
                                <li onclick="switchSection('settings', 'settings-content')">
                                    <i class="fas fa-cog"></i>
                                    <span data-i18n="settings">Settings</span>
                                </li>
                                <li>
                                    <i class="fas fa-palette"></i>
                                    <span data-i18n="darkMode">Dark Mode</span>
                                    <label class="theme-switch" style="margin-left: auto;">
                                        <input type="checkbox" id="themeToggle" checked onchange="toggleTheme()">
                                        <span class="switch-slider"></span>
                                    </label>
                                </li>
                                <li onclick="toggleLanguage()">
                                    <i class="fas fa-globe"></i>
                                    <span data-i18n="language">Language</span>
                                    <div class="lang-option" id="currentLang">EN</div>
                                </li>
                            </ul>
                            <div class="dropdown-divider"></div>
                            <ul class="dropdown-menu">
                                <li class="logout" onclick="logout()">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span data-i18n="logout">Logout</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Dashboard Content -->
            <div id="dashboard-content" class="content-section active">
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <div class="stat-details">
                            <h3 data-i18n="totalTrades">Total Trades</h3>
                            <p class="counter" id="totalTrades">0</p>
                            <span class="trend positive" id="totalTradesTrend">0 trades</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="stat-details">
                            <h3 data-i18n="winRate">Win Rate</h3>
                            <p class="counter" id="winRate">0%</p>
                            <span class="trend positive" id="winRateTrend">-</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-details">
                            <h3 data-i18n="totalPnL">Total P&L</h3>
                            <p class="counter" id="totalPnL">$0</p>
                            <span class="trend positive" id="pnlTrend">$0</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <div class="stat-details">
                            <h3 data-i18n="profitFactor">Profit Factor</h3>
                            <p class="counter" id="profitFactor">-</p>
                            <span class="trend positive" data-i18n="riskManagement">Risk Management</span>
                        </div>
                    </div>
                </div>

                <div class="charts-container">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h2 data-i18n="weeklyPerformance">Weekly Performance</h2>
                            <select class="revenue-filter" id="statsFilter" onchange="updateCharts()">
                                <option value="7" data-i18n="last7Days">Last 7 Days</option>
                                <option value="30" data-i18n="last30Days">Last 30 Days</option>
                                <option value="90" data-i18n="last3Months">Last 3 Months</option>
                                <option value="365" data-i18n="thisYear">This Year</option>
                            </select>
                        </div>
                        <div id="overallStatsChart"></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 data-i18n="mostActiveSymbols">Most Active Symbols</h3>
                        </div>
                        <div class="symbol-stats" id="symbolStats">
                            <div class="empty-state">
                                <i class="fas fa-chart-bar"></i>
                                <p data-i18n="noTradingData">No trading data yet</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="trade-history-card">
                    <div class="trade-history-header">
                        <h2 data-i18n="tradeHistory">Trade History</h2>
                        <button class="btn-add-trade" onclick="openTradeModal()">
                            <i class="fas fa-plus"></i>
                            <span data-i18n="addTrade">Add Trade</span>
                        </button>
                    </div>
                    <div class="trade-table-container" id="tradeHistoryTable">
                        <div class="empty-state">
                            <i class="fas fa-history"></i>
                            <h3 data-i18n="noTradeHistory">No trade history yet</h3>
                            <p data-i18n="startJournal">Click "Add Trade" button to start your trading journal</p>
                        </div>
                    </div>
                </div>

                <!-- Trading Calendar -->
                <div class="calendar-card">
                    <div class="calendar-header">
                        <h2><i class="fas fa-calendar-alt"></i> <span data-i18n="tradingCalendar">Trading Calendar</span></h2>
                        <div class="month-nav">
                            <button onclick="changeCalendarMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                            <span id="calendarMonth">February 2025</span>
                            <button onclick="changeCalendarMonth(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="tradingCalendar"></div>
                </div>
            </div>

            <!-- Analytics Content -->
            <div id="analytics-content" class="content-section">
                <div class="analytics-metrics">
                    <div class="metric-card">
                        <i class="fas fa-chart-line"></i>
                        <div class="metric-info">
                            <h3 data-i18n="avgWin">Average Win</h3>
                            <p class="counter" id="avgWin">$0</p>
                        </div>
                    </div>
                    <div class="metric-card">
                        <i class="fas fa-chart-area"></i>
                        <div class="metric-info">
                            <h3 data-i18n="avgLoss">Average Loss</h3>
                            <p class="counter" id="avgLoss">$0</p>
                        </div>
                    </div>
                    <div class="metric-card">
                        <i class="fas fa-percentage"></i>
                        <div class="metric-info">
                            <h3 data-i18n="expectancy">Expectancy</h3>
                            <p class="counter" id="expectancy">$0</p>
                        </div>
                    </div>
                    <div class="metric-card">
                        <i class="fas fa-chart-pie"></i>
                        <div class="metric-info">
                            <h3 data-i18n="maxDrawdown">Max Drawdown</h3>
                            <p class="counter" id="maxDrawdown">$0</p>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-grid" style="margin-top: 1.5rem;">
                    <div class="analytics-card">
                        <h3 data-i18n="pnlDistribution">P&L Distribution</h3>
                        <div id="pnlDistributionChart"></div>
                    </div>
                    <div class="analytics-card">
                        <h3 data-i18n="performanceBySymbol">Performance by Symbol</h3>
                        <div id="symbolPerformanceChart"></div>
                    </div>
                    <div class="analytics-card">
                        <h3 data-i18n="winLossByDay">Win/Loss by Day</h3>
                        <div id="dayPerformanceChart"></div>
                    </div>
                    <div class="analytics-card">
                        <h3 data-i18n="riskRewardAnalysis">Risk:Reward Analysis</h3>
                        <div id="riskRewardChart"></div>
                    </div>
                    <div class="analytics-card">
                        <h3 data-i18n="equityCurve">Equity Curve</h3>
                        <div id="equityCurveChart"></div>
                    </div>
                    <div class="analytics-card">
                        <h3 data-i18n="monthlyPerformance">Monthly Performance</h3>
                        <div id="monthlyPerformanceChart"></div>
                    </div>
                </div>
            </div>

            <!-- Projects Content -->
            <div id="projects-content" class="content-section">
                <div class="projects-header">
                    <div>
                        <h2 data-i18n="tradingGoals">Trading Goals & Targets</h2>
                        <p style="color: var(--text-secondary); margin-top: 0.5rem;" data-i18n="manageTargets">Manage your trading targets and strategies</p>
                    </div>
                    <button class="btn-add-project" onclick="openProjectModal()">
                        <i class="fas fa-plus"></i>
                        <span data-i18n="addTarget">Add Target</span>
                    </button>
                </div>
                <div class="projects-grid" id="projectsGrid"></div>
            </div>

            <!-- Settings Content -->
            <div id="settings-content" class="content-section">
                <div style="margin-bottom: 1.5rem;">
                    <h2 data-i18n="settings">Settings</h2>
                    <p style="color: var(--text-secondary); margin-top: 0.5rem;" data-i18n="customizeJournal">Customize your trading journal</p>
                </div>
                <div class="settings-grid">
                    <div class="settings-card">
                        <h3><i class="fas fa-palette"></i> <span data-i18n="appearance">Appearance</span></h3>
                        <div class="setting-option">
                            <div class="setting-info">
                                <h4 data-i18n="darkMode">Dark Mode</h4>
                                <p data-i18n="toggleDarkMode">Toggle between dark and light mode</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="settingsThemeToggle" checked onchange="toggleTheme()">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-option">
                            <div class="setting-info">
                                <h4 data-i18n="language">Language</h4>
                                <p data-i18n="selectLanguage">Choose your preferred language</p>
                            </div>
                            <div class="lang-selector">
                                <button class="lang-btn active" onclick="setLanguage('en')" id="lang-en">English</button>
                                <button class="lang-btn" onclick="setLanguage('id')" id="lang-id">Indonesia</button>
                            </div>
                        </div>
                    </div>
                    <div class="settings-card">
                        <h3><i class="fas fa-bell"></i> <span data-i18n="notifications">Notifications</span></h3>
                        <div class="setting-option">
                            <div class="setting-info">
                                <h4 data-i18n="tradeNotifications">Trade Notifications</h4>
                                <p data-i18n="showTradeNotif">Show notifications when trade is added</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" checked id="notifTradeToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-option">
                            <div class="setting-info">
                                <h4 data-i18n="dailyReminder">Daily Reminder</h4>
                                <p data-i18n="sendDailyReminder">Send reminder for daily trading review</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Trade Modal -->
    <div class="modal-overlay" id="tradeModal">
        <div class="modal">
            <div class="modal-header">
                <h2>
                    <i class="fas fa-plus-circle"></i>
                    <span id="modalTitle" data-i18n="addNewTrade">Add New Trade</span>
                </h2>
                <button class="btn-close" onclick="closeTradeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="tradeForm">
                <div class="modal-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="result" data-i18n="result">Result *</label>
                            <select id="result" name="result" required>
                                <option value="" data-i18n="selectResult">Select Result</option>
                                <option value="WIN">WIN</option>
                                <option value="LOSS">LOSS</option>
                                <option value="BREAKEVEN">BREAKEVEN</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="symbol" data-i18n="symbol">Symbol *</label>
                            <input type="text" id="symbol" name="symbol" placeholder="XAUUSD, BTCUSD..." required>
                        </div>
                        <div class="form-group">
                            <label for="open_date" data-i18n="openDate">Open Date *</label>
                            <input type="datetime-local" id="open_date" name="open_date" required>
                        </div>
                        <div class="form-group">
                            <label for="type" data-i18n="type">Type *</label>
                            <select id="type" name="type" required>
                                <option value="" data-i18n="selectType">Select Type</option>
                                <option value="forex">Forex</option>
                                <option value="crypto">Crypto</option>
                                <option value="stock">Stock</option>
                                <option value="commodity">Commodity</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="side" data-i18n="side">Side *</label>
                            <select id="side" name="side" required>
                                <option value="" data-i18n="selectSide">Select Side</option>
                                <option value="buy">BUY</option>
                                <option value="sell">SELL</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="time_frame" data-i18n="timeFrame">Time Frame</label>
                            <select id="time_frame" name="time_frame">
                                <option value="" data-i18n="selectTF">Select TF</option>
                                <option value="M1">M1</option>
                                <option value="M5">M5</option>
                                <option value="M15">M15</option>
                                <option value="M30">M30</option>
                                <option value="H1">H1</option>
                                <option value="H4">H4</option>
                                <option value="D1">D1</option>
                                <option value="W1">W1</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="risk_reward" data-i18n="riskReward">Risk:Reward</label>
                            <select id="risk_reward" name="risk_reward">
                                <option value="" data-i18n="selectRR">Select R:R</option>
                                <option value="1:1">1:1</option>
                                <option value="1:2">1:2</option>
                                <option value="1:3">1:3</option>
                                <option value="1:4">1:4</option>
                                <option value="1:5">1:5</option>
                                <option value="1:6">1:6</option>
                                <option value="1:7">1:7</option>
                                <option value="1:8">1:8</option>
                                <option value="1:9">1:9</option>
                                <option value="1:10">1:10</option>
                            </select>
                        </div>
                        <!-- PERBAIKAN: Input P&L dengan support desimal -->
                        <div class="form-group">
                            <label for="pnl" data-i18n="pnl">P&L (USD) *</label>
                            <input type="number" id="pnl" name="pnl" step="0.01" min="-999999" max="999999" placeholder="0.00" required>
                            <small>Contoh: 0.30, 1.50, 10.00, 100.00 (desimal diperbolehkan)</small>
                        </div>
                        <div class="form-group">
                            <label for="image_before" data-i18n="imageBefore">Image Before</label>
                            <input type="url" id="image_before" name="image_before" placeholder="Screenshot link...">
                        </div>
                        <div class="form-group">
                            <label for="image_after" data-i18n="imageAfter">Image After</label>
                            <input type="url" id="image_after" name="image_after" placeholder="Screenshot link...">
                        </div>
                        <div class="form-group full-width">
                            <label for="note" data-i18n="note">Note / Analysis</label>
                            <textarea id="note" name="note" placeholder="Trading notes, setup, entry reasons..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeTradeModal()" data-i18n="cancel">Cancel</button>
                    <button type="submit" class="btn-save" id="saveTradeBtn">
                        <i class="fas fa-save"></i>
                        <span data-i18n="saveTrade">Save Trade</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Day Trades Modal -->
    <div class="modal-overlay" id="dayTradesModal">
        <div class="modal day-transactions-modal">
            <div class="modal-header">
                <h2>
                    <i class="fas fa-calendar-day"></i>
                    <span id="dayModalTitle">Trades</span>
                </h2>
                <button class="btn-close" onclick="closeDayTradesModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="day-summary" id="daySummary"></div>
                <div class="trades-list" id="dayTradesList"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeDayTradesModal()" data-i18n="close">Close</button>
                <button type="button" class="btn-save" onclick="openTradeModal(); closeDayTradesModal();">
                    <i class="fas fa-plus"></i> <span data-i18n="addTrade">Add Trade</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div class="modal-overlay" id="projectModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2>
                    <i class="fas fa-bullseye"></i>
                    <span id="projectModalTitle" data-i18n="addNewTarget">Add New Target</span>
                </h2>
                <button class="btn-close" onclick="closeProjectModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="projectForm">
                <div class="modal-body">
                    <div class="form-grid" style="grid-template-columns: 1fr;">
                        <div class="form-group">
                            <label for="projectTitle" data-i18n="targetTitle">Target Title *</label>
                            <input type="text" id="projectTitle" name="title" placeholder="e.g., Monthly Profit Target" required>
                        </div>
                        <div class="form-group">
                            <label for="projectDescription" data-i18n="description">Description</label>
                            <textarea id="projectDescription" name="description" placeholder="Target description or strategy..."></textarea>
                        </div>
                        <div class="form-group">
                            <label data-i18n="subTargets">Sub-targets (Optional)</label>
                            <div id="targetsContainer">
                                <input type="text" class="target-input" placeholder="Target 1" style="margin-bottom: 0.5rem; width: 100%; padding: 0.8rem; background: var(--glass-bg); border: 2px solid var(--glass-border); border-radius: 8px; color: var(--text-primary);">
                            </div>
                            <button type="button" onclick="addTargetInput()" style="margin-top: 0.5rem; background: transparent; border: 1px dashed var(--primary-color); color: var(--primary-color); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                                <i class="fas fa-plus"></i> <span data-i18n="addSubTarget">Add Sub-target</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeProjectModal()" data-i18n="cancel">Cancel</button>
                    <button type="submit" class="btn-save">
                        <i class="fas fa-save"></i>
                        <span data-i18n="saveTarget">Save Target</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script>
        // ==========================================
// SUPABASE CONFIGURATION
// ==========================================
const SUPABASE_URL = 'https://bidhhwcuhisuptgonyfd.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpZGhod2N1aGlzdXB0Z29ueWZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyOTgxNDksImV4cCI6MjA4Njg3NDE0OX0.fb7FGMAEOHhyYpsTpzJ9ZGZpwQaA8INnHtq9NiHqCwU';

// Global Variables
let currentUser = null;
let currentSession = null;
let tradesData = [];
let projectsData = [];
let currentEditId = null;
let charts = {};
let supabaseClient = null;
let currentCalendarDate = new Date();

// Language Support
let currentLanguage = localStorage.getItem('language') || 'en';

const translations = {
    en: {
        loading: 'Loading Trading Journal...',
        dashboard: 'Dashboard',
        analytics: 'Analytics',
        goals: 'Goals & Targets',
        settings: 'Settings',
        trading: 'Trading',
        budget: 'Budget',
        active: 'Active',
        darkMode: 'Dark Mode',
        language: 'Language',
        logout: 'Logout',
        searchPlaceholder: 'Search trades or symbols...',
        totalTrades: 'Total Trades',
        winRate: 'Win Rate',
        totalPnL: 'Total P&L',
        profitFactor: 'Profit Factor',
        riskManagement: 'Risk Management',
        weeklyPerformance: 'Weekly Performance',
        last7Days: 'Last 7 Days',
        last30Days: 'Last 30 Days',
        last3Months: 'Last 3 Months',
        thisYear: 'This Year',
        mostActiveSymbols: 'Most Active Symbols',
        noTradingData: 'No trading data yet',
        tradeHistory: 'Trade History',
        addTrade: 'Add Trade',
        noTradeHistory: 'No trade history yet',
        startJournal: 'Click "Add Trade" button to start your trading journal',
        tradingCalendar: 'Trading Calendar',
        avgWin: 'Average Win',
        avgLoss: 'Average Loss',
        expectancy: 'Expectancy',
        maxDrawdown: 'Max Drawdown',
        pnlDistribution: 'P&L Distribution',
        performanceBySymbol: 'Performance by Symbol',
        winLossByDay: 'Win/Loss by Day',
        riskRewardAnalysis: 'Risk:Reward Analysis',
        equityCurve: 'Equity Curve',
        monthlyPerformance: 'Monthly Performance',
        tradingGoals: 'Trading Goals & Targets',
        manageTargets: 'Manage your trading targets and strategies',
        addTarget: 'Add Target',
        customizeJournal: 'Customize your trading journal',
        appearance: 'Appearance',
        toggleDarkMode: 'Toggle between dark and light mode',
        selectLanguage: 'Choose your preferred language',
        notifications: 'Notifications',
        tradeNotifications: 'Trade Notifications',
        showTradeNotif: 'Show notifications when trade is added',
        dailyReminder: 'Daily Reminder',
        sendDailyReminder: 'Send reminder for daily trading review',
        addNewTrade: 'Add New Trade',
        addNewTarget: 'Add New Target',
        result: 'Result',
        selectResult: 'Select Result',
        symbol: 'Symbol',
        openDate: 'Open Date',
        type: 'Type',
        selectType: 'Select Type',
        side: 'Side',
        selectSide: 'Select Side',
        timeFrame: 'Time Frame',
        selectTF: 'Select TF',
        riskReward: 'Risk:Reward',
        selectRR: 'Select R:R',
        pnl: 'P&L (USD)',
        imageBefore: 'Image Before',
        imageAfter: 'Image After',
        note: 'Note / Analysis',
        cancel: 'Cancel',
        saveTrade: 'Save Trade',
        close: 'Close',
        targetTitle: 'Target Title',
        description: 'Description',
        subTargets: 'Sub-targets',
        addSubTarget: 'Add Sub-target',
        saveTarget: 'Save Target',
        totalWin: 'Total Win',
        totalLoss: 'Total Loss',
        netPnL: 'Net P&L',
        win: 'Win',
        loss: 'Loss',
        breakeven: 'Breakeven'
    },
    id: {
        loading: 'Memuat Jurnal Trading...',
        dashboard: 'Dasbor',
        analytics: 'Analitik',
        goals: 'Tujuan & Target',
        settings: 'Pengaturan',
        trading: 'Trading',
        budget: 'Anggaran',
        active: 'Aktif',
        darkMode: 'Mode Gelap',
        language: 'Bahasa',
        logout: 'Keluar',
        searchPlaceholder: 'Cari trading atau simbol...',
        totalTrades: 'Total Trading',
        winRate: 'Tingkat Menang',
        totalPnL: 'Total P&L',
        profitFactor: 'Faktor Profit',
        riskManagement: 'Manajemen Risiko',
        weeklyPerformance: 'Performa Mingguan',
        last7Days: '7 Hari Terakhir',
        last30Days: '30 Hari Terakhir',
        last3Months: '3 Bulan Terakhir',
        thisYear: 'Tahun Ini',
        mostActiveSymbols: 'Simbol Paling Aktif',
        noTradingData: 'Belum ada data trading',
        tradeHistory: 'Riwayat Trading',
        addTrade: 'Tambah Trading',
        noTradeHistory: 'Belum ada riwayat trading',
        startJournal: 'Klik tombol "Tambah Trading" untuk memulai jurnal trading Anda',
        tradingCalendar: 'Kalender Trading',
        avgWin: 'Rata-rata Menang',
        avgLoss: 'Rata-rata Kalah',
        expectancy: 'Ekspektasi',
        maxDrawdown: 'Drawdown Maksimal',
        pnlDistribution: 'Distribusi P&L',
        performanceBySymbol: 'Performa per Simbol',
        winLossByDay: 'Menang/Kalah per Hari',
        riskRewardAnalysis: 'Analisis Risk:Reward',
        equityCurve: 'Kurva Ekuitas',
        monthlyPerformance: 'Performa Bulanan',
        tradingGoals: 'Tujuan & Target Trading',
        manageTargets: 'Kelola target dan strategi trading Anda',
        addTarget: 'Tambah Target',
        customizeJournal: 'Sesuaikan jurnal trading Anda',
        appearance: 'Tampilan',
        toggleDarkMode: 'Alihkan antara mode gelap dan terang',
        selectLanguage: 'Pilih bahasa yang Anda sukai',
        notifications: 'Notifikasi',
        tradeNotifications: 'Notifikasi Trading',
        showTradeNotif: 'Tampilkan notifikasi saat trading ditambahkan',
        dailyReminder: 'Pengingat Harian',
        sendDailyReminder: 'Kirim pengingat untuk review trading harian',
        addNewTrade: 'Tambah Trading Baru',
        addNewTarget: 'Tambah Target Baru',
        result: 'Hasil',
        selectResult: 'Pilih Hasil',
        symbol: 'Simbol',
        openDate: 'Tanggal Buka',
        type: 'Tipe',
        selectType: 'Pilih Tipe',
        side: 'Sisi',
        selectSide: 'Pilih Sisi',
        timeFrame: 'Time Frame',
        selectTF: 'Pilih TF',
        riskReward: 'Risk:Reward',
        selectRR: 'Pilih R:R',
        pnl: 'P&L (USD)',
        imageBefore: 'Gambar Sebelum',
        imageAfter: 'Gambar Sesudah',
        note: 'Catatan / Analisis',
        cancel: 'Batal',
        saveTrade: 'Simpan Trading',
        close: 'Tutup',
        targetTitle: 'Judul Target',
        description: 'Deskripsi',
        subTargets: 'Sub-target',
        addSubTarget: 'Tambah Sub-target',
        saveTarget: 'Simpan Target',
        totalWin: 'Total Menang',
        totalLoss: 'Total Kalah',
        netPnL: 'Net P&L',
        win: 'Menang',
        loss: 'Kalah',
        breakeven: 'Imbang'
    }
};

// ==========================================
// INITIALIZATION
// ==========================================
document.addEventListener('DOMContentLoaded', async () => {
    // Apply saved language
    applyLanguage(currentLanguage);
    
    try {
        const { createClient } = supabase;
        supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        
        if (error) throw error;
        
        if (session) {
            currentSession = session;
            currentUser = session.user;
            await initializeDashboard();
        } else {
            window.location.href = 'index.html';
        }
        
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_IN' && session) {
                currentSession = session;
                currentUser = session.user;
                await initializeDashboard();
            } else if (event === 'SIGNED_OUT') {
                window.location.href = 'index.html';
            }
        });
        
    } catch (error) {
        console.error('Initialization error:', error);
        showNotification('Error initializing app: ' + error.message, 'error');
        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen) {
            loadingScreen.style.display = 'none';
        }
        window.location.href = 'index.html';
    }
    
    setupEventListeners();
});

// ==========================================
// LANGUAGE FUNCTIONS
// ==========================================
function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem('language', lang);
    applyLanguage(lang);
    
    // Update UI
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById(`lang-${lang}`).classList.add('active');
    
    // Update dropdown indicator
    const langIndicator = document.getElementById('currentLang');
    if (langIndicator) {
        langIndicator.textContent = lang.toUpperCase();
    }
    
    showNotification(
        lang === 'en' ? 'Language changed to English' : 'Bahasa diubah ke Indonesia', 
        'success'
    );
    
    // Refresh charts and tables to update labels
    updateStats();
    renderCharts();
    renderTradeTable();
    renderCalendar();
}

function applyLanguage(lang) {
    const t = translations[lang];
    
    // Update all elements with data-i18n
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) {
            el.textContent = t[key];
        }
    });
    
    // Update placeholders
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (t[key]) {
            el.placeholder = t[key];
        }
    });
    
    // Update language buttons
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    const activeBtn = document.getElementById(`lang-${lang}`);
    if (activeBtn) activeBtn.classList.add('active');
    
    // Update dropdown indicator
    const langIndicator = document.getElementById('currentLang');
    if (langIndicator) {
        langIndicator.textContent = lang.toUpperCase();
    }
    
    // Update loading text
    const loadingText = document.querySelector('.loading-text');
    if (loadingText) {
        loadingText.textContent = t.loading;
    }
}

function toggleLanguage() {
    const newLang = currentLanguage === 'en' ? 'id' : 'en';
    setLanguage(newLang);
    toggleProfile(); // Close dropdown
}

// ==========================================
// EVENT LISTENERS SETUP
// ==========================================
function setupEventListeners() {
    // Close modals on outside click
    const tradeModal = document.getElementById('tradeModal');
    const projectModal = document.getElementById('projectModal');
    const dayTradesModal = document.getElementById('dayTradesModal');
    
    if (tradeModal) {
        tradeModal.addEventListener('click', function(e) {
            if (e.target === this) closeTradeModal();
        });
    }
    
    if (projectModal) {
        projectModal.addEventListener('click', function(e) {
            if (e.target === this) closeProjectModal();
        });
    }
    
    if (dayTradesModal) {
        dayTradesModal.addEventListener('click', function(e) {
            if (e.target === this) closeDayTradesModal();
        });
    }

    // Search functionality
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(function(e) {
            const searchTerm = e.target.value.toLowerCase();
            filterTrades(searchTerm);
        }, 300));
    }

    // Navigation click handlers
    document.querySelectorAll('.nav-links li').forEach(link => {
        link.addEventListener('click', () => {
            switchSection(link.dataset.section, link.dataset.content);
        });
    });

    // Form submissions
    const tradeForm = document.getElementById('tradeForm');
    if (tradeForm) {
        tradeForm.removeAttribute('onsubmit');
        tradeForm.addEventListener('submit', saveTrade);
    }

    const projectForm = document.getElementById('projectForm');
    if (projectForm) {
        projectForm.removeAttribute('onsubmit');
        projectForm.addEventListener('submit', saveProject);
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.profile')) {
            const profileDropdown = document.getElementById('profileDropdown');
            if (profileDropdown) {
                profileDropdown.classList.remove('active');
            }
        }
    });
}

// ==========================================
// DASHBOARD INITIALIZATION
// ==========================================
async function initializeDashboard() {
    updateUserUI(currentUser);
    
    await Promise.all([
        loadTrades(),
        loadProjects()
    ]);
    
    updateStats();
    renderCharts();
    renderTradeTable();
    renderCalendar();
    renderProjects();
    
    setupRealtimeSubscription();
    
    setTimeout(() => {
        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen) {
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 500);
        }
    }, 1000);
}

function updateUserUI(user) {
    const email = user.email || 'trader@journal.com';
    const name = user.user_metadata?.full_name || email.split('@')[0];
    const initials = name.substring(0, 2).toUpperCase();
    
    document.getElementById('headerName').textContent = name;
    document.getElementById('headerAvatar').textContent = initials;
    document.getElementById('dropdownName').textContent = name;
    document.getElementById('dropdownEmail').textContent = email;
    document.getElementById('dropdownAvatar').textContent = initials;
}

// ==========================================
// REAL-TIME SUBSCRIPTION
// ==========================================
function setupRealtimeSubscription() {
    if (!supabaseClient || !currentUser) return;
    
    supabaseClient
        .channel('trades_changes')
        .on('postgres_changes', 
            { 
                event: '*', 
                schema: 'public', 
                table: 'trades',
                filter: `user_id=eq.${currentUser.id}`
            }, 
            (payload) => {
                console.log('Real-time update:', payload);
                handleRealtimeUpdate(payload);
            }
        )
        .subscribe();
}

function handleRealtimeUpdate(payload) {
    const { eventType, new: newRecord, old: oldRecord } = payload;
    
    switch(eventType) {
        case 'INSERT':
            tradesData.unshift(newRecord);
            break;
        case 'UPDATE':
            const index = tradesData.findIndex(t => t.id === oldRecord.id);
            if (index !== -1) tradesData[index] = newRecord;
            break;
        case 'DELETE':
            tradesData = tradesData.filter(t => t.id !== oldRecord.id);
            break;
    }
    
    updateStats();
    renderCharts();
    renderTradeTable();
    renderCalendar();
    showNotification(currentLanguage === 'en' ? 'Data updated in real-time' : 'Data diperbarui real-time', 'info');
}

// ==========================================
// DATA LOADING FROM SUPABASE
// ==========================================
async function loadTrades() {
    try {
        const { data, error } = await supabaseClient
            .from('trades')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('open_date', { ascending: false });

        if (error) throw error;
        
        tradesData = data || [];
        
    } catch (error) {
        console.error('Error loading trades:', error);
        showNotification('Error loading trade data: ' + error.message, 'error');
        tradesData = [];
    }
}

async function loadProjects() {
    try {
        const { data, error } = await supabaseClient
            .from('projects')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });

        if (error) throw error;
        
        projectsData = data || [];
        
    } catch (error) {
        console.error('Error loading projects:', error);
        projectsData = [];
    }
}

// ==========================================
// CALENDAR FUNCTIONS
// ==========================================
function renderCalendar() {
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    
    const monthNames = currentLanguage === 'en' 
        ? ['January', 'February', 'March', 'April', 'May', 'June', 
           'July', 'August', 'September', 'October', 'November', 'December']
        : ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
           'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
    
    const calendarMonth = document.getElementById('calendarMonth');
    if (calendarMonth) {
        calendarMonth.textContent = `${monthNames[month]} ${year}`;
    }
    
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();
    
    const grid = document.getElementById('tradingCalendar');
    if (!grid) return;
    
    grid.innerHTML = '';
    
    const dayNames = currentLanguage === 'en'
        ? ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
        : ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
    
    dayNames.forEach(day => {
        const header = document.createElement('div');
        header.className = 'day-header';
        header.textContent = day;
        grid.appendChild(header);
    });
    
    // Previous month days
    for (let i = firstDay - 1; i >= 0; i--) {
        const dayDiv = createCalendarDayElement(daysInPrevMonth - i, true);
        grid.appendChild(dayDiv);
    }
    
    // Current month days
    const today = new Date();
    for (let day = 1; day <= daysInMonth; day++) {
        const isToday = today.getDate() === day && 
                       today.getMonth() === month && 
                       today.getFullYear() === year;
        const dayDiv = createCalendarDayElement(day, false, isToday, year, month);
        grid.appendChild(dayDiv);
    }
    
    // Next month days
    const remainingCells = 42 - (firstDay + daysInMonth);
    for (let day = 1; day <= remainingCells; day++) {
        const dayDiv = createCalendarDayElement(day, true);
        grid.appendChild(dayDiv);
    }
}

function createCalendarDayElement(day, isOtherMonth, isToday = false, year = null, month = null) {
    const div = document.createElement('div');
    div.className = 'calendar-day' + (isOtherMonth ? ' other-month' : '') + (isToday ? ' today' : '');
    
    const dayNum = document.createElement('div');
    dayNum.className = 'day-number';
    dayNum.textContent = day;
    div.appendChild(dayNum);
    
    if (!isOtherMonth && year !== null) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayTrades = tradesData.filter(t => {
            const tradeDate = new Date(t.open_date);
            return tradeDate.toISOString().split('T')[0] === dateStr;
        });
        
        if (dayTrades.length > 0) {
            let totalWin = 0;
            let totalLoss = 0;
            let netPnL = 0;
            
            dayTrades.forEach(trade => {
                const pnl = parseFloat(trade.pnl) || 0;
                netPnL += pnl;
                if (pnl > 0) totalWin += pnl;
                else if (pnl < 0) totalLoss += Math.abs(pnl);
            });
            
            if (netPnL > 0) div.classList.add('win-day');
            else if (netPnL < 0) div.classList.add('loss-day');
            
            const pnlDiv = document.createElement('div');
            pnlDiv.className = 'day-pnl';
            
            if (totalWin > 0) {
                const winDiv = document.createElement('div');
                winDiv.className = 'day-pnl-win';
                winDiv.textContent = '+' + formatCurrencyShort(totalWin);
                pnlDiv.appendChild(winDiv);
            }
            
            if (totalLoss > 0) {
                const lossDiv = document.createElement('div');
                lossDiv.className = 'day-pnl-loss';
                lossDiv.textContent = '-' + formatCurrencyShort(totalLoss);
                pnlDiv.appendChild(lossDiv);
            }
            
            const netDiv = document.createElement('div');
            netDiv.className = 'day-net ' + (netPnL >= 0 ? 'positive' : 'negative');
            netDiv.textContent = (netPnL >= 0 ? '+' : '') + formatCurrencyShort(netPnL);
            pnlDiv.appendChild(netDiv);
            
            div.appendChild(pnlDiv);
            div.onclick = () => showDayTrades(dateStr);
        }
    }
    
    return div;
}

function changeCalendarMonth(delta) {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
    renderCalendar();
}

function showDayTrades(date) {
    const dayTrades = tradesData.filter(t => {
        const tradeDate = new Date(t.open_date);
        return tradeDate.toISOString().split('T')[0] === date;
    });
    
    const dateObj = new Date(date);
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const dayModalTitle = document.getElementById('dayModalTitle');
    if (dayModalTitle) {
        dayModalTitle.textContent = dateObj.toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'id-ID', options);
    }
    
    let totalWin = 0;
    let totalLoss = 0;
    
    dayTrades.forEach(trade => {
        const pnl = parseFloat(trade.pnl) || 0;
        if (pnl > 0) totalWin += pnl;
        else if (pnl < 0) totalLoss += Math.abs(pnl);
    });
    
    const netPnL = totalWin - totalLoss;
    const t = translations[currentLanguage];
    
    const summaryHtml = `
        <div class="day-summary-item win">
            <div class="day-summary-label">${t.totalWin}</div>
            <div class="day-summary-amount">+${formatCurrency(totalWin)}</div>
        </div>
        <div class="day-summary-item loss">
            <div class="day-summary-label">${t.totalLoss}</div>
            <div class="day-summary-amount">-${formatCurrency(totalLoss)}</div>
        </div>
        <div class="day-summary-item" style="grid-column: 1 / -1; border-left: 4px solid ${netPnL >= 0 ? 'var(--success)' : 'var(--danger)'};">
            <div class="day-summary-label">${t.netPnL}</div>
            <div class="day-summary-amount" style="color: ${netPnL >= 0 ? 'var(--success)' : 'var(--danger)'};">
                ${netPnL >= 0 ? '+' : ''}${formatCurrency(netPnL)}
            </div>
        </div>
    `;
    
    const daySummary = document.getElementById('daySummary');
    if (daySummary) {
        daySummary.innerHTML = summaryHtml;
    }
    
    const listContainer = document.getElementById('dayTradesList');
    if (!listContainer) return;
    
    if (dayTrades.length === 0) {
        listContainer.innerHTML = `
            <div class="no-trades">
                <i class="fas fa-inbox"></i>
                <p>${currentLanguage === 'en' ? 'No trades on this day' : 'Tidak ada trading hari ini'}</p>
            </div>
        `;
    } else {
        listContainer.innerHTML = dayTrades.map(trade => {
            const pnl = parseFloat(trade.pnl) || 0;
            let iconClass = 'breakeven';
            let icon = 'minus';
            
            if (trade.result === 'WIN') {
                iconClass = 'win';
                icon = 'trophy';
            } else if (trade.result === 'LOSS') {
                iconClass = 'loss';
                icon = 'times';
            }
            
            return `
                <div class="trade-item">
                    <div class="trade-item-icon ${iconClass}">
                        <i class="fas fa-${icon}"></i>
                    </div>
                    <div class="trade-item-details">
                        <div class="trade-item-symbol">${trade.symbol} (${trade.side?.toUpperCase()})</div>
                        <div class="trade-item-meta">
                            ${trade.type}  ${trade.time_frame || 'N/A'}  ${formatTime(trade.open_date)}
                        </div>
                    </div>
                    <div class="trade-item-amount">
                        <div class="amount ${iconClass}">
                            ${pnl >= 0 ? '+' : ''}${formatCurrency(pnl)}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    const dayTradesModal = document.getElementById('dayTradesModal');
    if (dayTradesModal) {
        dayTradesModal.classList.add('active');
    }
}

function closeDayTradesModal() {
    const dayTradesModal = document.getElementById('dayTradesModal');
    if (dayTradesModal) {
        dayTradesModal.classList.remove('active');
    }
}

// ==========================================
// STATISTICS & ANALYTICS
// ==========================================
function updateStats() {
    const total = tradesData.length;
    const wins = tradesData.filter(t => t.result === 'WIN').length;
    const losses = tradesData.filter(t => t.result === 'LOSS').length;
    
    const winRate = total > 0 ? ((wins / total) * 100).toFixed(1) : 0;
    const totalPnL = tradesData.reduce((sum, t) => sum + (parseFloat(t.pnl) || 0), 0);
    
    const grossProfit = tradesData
        .filter(t => parseFloat(t.pnl) > 0)
        .reduce((sum, t) => sum + parseFloat(t.pnl), 0);
    const grossLoss = Math.abs(tradesData
        .filter(t => parseFloat(t.pnl) < 0)
        .reduce((sum, t) => sum + parseFloat(t.pnl), 0));
    const profitFactor = grossLoss > 0 ? (grossProfit / grossLoss).toFixed(2) : 
                        grossProfit > 0 ? '' : '-';

    document.getElementById('totalTrades').textContent = total;
    document.getElementById('winRate').textContent = winRate + '%';
    document.getElementById('totalPnL').textContent = formatCurrency(totalPnL);
    document.getElementById('profitFactor').textContent = profitFactor;

    const t = translations[currentLanguage];
    document.getElementById('totalTradesTrend').textContent = total + ' ' + (currentLanguage === 'en' ? 'trades' : 'trading');
    document.getElementById('winRateTrend').textContent = winRate >= 50 ? (currentLanguage === 'en' ? 'Good' : 'Bagus') : (currentLanguage === 'en' ? 'Improve' : 'Perlu Ditingkatkan');
    document.getElementById('winRateTrend').className = 'trend ' + (winRate >= 50 ? 'positive' : 'negative');
    document.getElementById('pnlTrend').textContent = (totalPnL >= 0 ? '+' : '') + formatCurrency(totalPnL);
    document.getElementById('pnlTrend').className = 'trend ' + (totalPnL >= 0 ? 'positive' : 'negative');

    updateAnalyticsMetrics();
}

function updateAnalyticsMetrics() {
    const winTrades = tradesData.filter(t => t.result === 'WIN' && parseFloat(t.pnl) > 0);
    const lossTrades = tradesData.filter(t => t.result === 'LOSS' && parseFloat(t.pnl) < 0);
    
    const avgWin = winTrades.length > 0 
        ? winTrades.reduce((sum, t) => sum + parseFloat(t.pnl), 0) / winTrades.length 
        : 0;
    const avgLoss = lossTrades.length > 0 
        ? Math.abs(lossTrades.reduce((sum, t) => sum + parseFloat(t.pnl), 0) / lossTrades.length)
        : 0;
    
    const winRate = tradesData.length > 0 ? (winTrades.length / tradesData.length) : 0;
    const lossRate = tradesData.length > 0 ? (lossTrades.length / tradesData.length) : 0;
    
    const expectancy = (winRate * avgWin) - (lossRate * avgLoss);
    
    let maxDrawdown = 0;
    let peak = 0;
    let runningPnL = 0;
    
    const sortedTrades = [...tradesData].sort((a, b) => 
        new Date(a.open_date) - new Date(b.open_date)
    );
    
    sortedTrades.forEach(trade => {
        runningPnL += parseFloat(trade.pnl) || 0;
        if (runningPnL > peak) peak = runningPnL;
        const drawdown = peak - runningPnL;
        if (drawdown > maxDrawdown) maxDrawdown = drawdown;
    });

    document.getElementById('avgWin').textContent = formatCurrency(avgWin);
    document.getElementById('avgLoss').textContent = formatCurrency(avgLoss);
    document.getElementById('expectancy').textContent = formatCurrency(expectancy);
    const expectancyEl = document.getElementById('expectancy');
    if (expectancyEl) {
        expectancyEl.className = 'counter ' + (expectancy >= 0 ? 'positive' : 'negative');
    }
    document.getElementById('maxDrawdown').textContent = formatCurrency(maxDrawdown);
}

// ==========================================
// CHARTS RENDERING
// ==========================================
function renderCharts() {
    renderOverallStatsChart();
    renderSymbolStats();
    renderAnalyticsCharts();
}

function renderOverallStatsChart() {
    const days = currentLanguage === 'en' 
        ? ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
        : ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'];
        
    const tradesByDay = new Array(7).fill(0);
    const pnlByDay = new Array(7).fill(0);
    
    tradesData.forEach(trade => {
        const date = new Date(trade.open_date);
        const dayIndex = date.getDay();
        const adjustedIndex = dayIndex === 0 ? 6 : dayIndex - 1;
        tradesByDay[adjustedIndex]++;
        pnlByDay[adjustedIndex] += parseFloat(trade.pnl) || 0;
    });

    const t = translations[currentLanguage];

    const options = {
        series: [{
            name: currentLanguage === 'en' ? 'Trades' : 'Trading',
            type: 'column',
            data: tradesByDay
        }, {
            name: 'P&L',
            type: 'line',
            data: pnlByDay
        }],
        chart: {
            height: 350,
            type: 'line',
            background: 'transparent',
            toolbar: { show: false }
        },
        stroke: { width: [0, 4] },
        plotOptions: {
            bar: { 
                columnWidth: '50%',
                borderRadius: 6
            }
        },
        colors: ['#6366f1', '#10b981'],
        dataLabels: { enabled: false },
        xaxis: {
            categories: days,
            labels: { style: { colors: '#94a3b8' } }
        },
        yaxis: [{
            title: { text: currentLanguage === 'en' ? 'Trades' : 'Trading', style: { color: '#6366f1' } },
            labels: { style: { colors: '#94a3b8' } }
        }, {
            opposite: true,
            title: { text: 'P&L ($)', style: { color: '#10b981' } },
            labels: { 
                style: { colors: '#94a3b8' },
                formatter: (val) => '$' + val.toFixed(0)
            }
        }],
        grid: { borderColor: '#1e293b' },
        tooltip: {
            y: { formatter: (val) => '$' + val.toFixed(2) }
        }
    };

    if (charts.overall) charts.overall.destroy();
    charts.overall = new ApexCharts(document.querySelector("#overallStatsChart"), options);
    charts.overall.render();
}

function renderSymbolStats() {
    const symbolCount = {};
    const symbolPnL = {};
    
    tradesData.forEach(trade => {
        const symbol = trade.symbol?.toUpperCase() || 'Unknown';
        symbolCount[symbol] = (symbolCount[symbol] || 0) + 1;
        symbolPnL[symbol] = (symbolPnL[symbol] || 0) + (parseFloat(trade.pnl) || 0);
    });

    const sortedSymbols = Object.entries(symbolCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

    const maxCount = sortedSymbols.length > 0 ? sortedSymbols[0][1] : 1;
    const container = document.getElementById('symbolStats');

    if (!container) return;

    if (sortedSymbols.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-chart-bar"></i>
                <p>${currentLanguage === 'en' ? 'No trading data yet' : 'Belum ada data trading'}</p>
            </div>
        `;
        return;
    }

    container.innerHTML = sortedSymbols.map(([symbol, count], index) => `
        <div class="symbol-item">
            <div class="symbol-rank">${index + 1}</div>
            <div class="symbol-info">
                <div class="symbol-name">${symbol}</div>
                <div class="symbol-count">${count} ${currentLanguage === 'en' ? 'trades' : 'trading'}  ${formatCurrency(symbolPnL[symbol])}</div>
            </div>
            <div class="symbol-bar">
                <div class="symbol-progress" style="width: ${(count / maxCount) * 100}%"></div>
            </div>
        </div>
    `).join('');
}

function renderAnalyticsCharts() {
    // P&L Distribution
    const pnlRanges = {
        '>$500': 0,
        '$200-$500': 0,
        '$0-$200': 0,
        '-$200-$0': 0,
        '-$500-$200': 0,
        '<-$500': 0
    };
    
    tradesData.forEach(trade => {
        const pnl = parseFloat(trade.pnl) || 0;
        if (pnl > 500) pnlRanges['>$500']++;
        else if (pnl > 200) pnlRanges['$200-$500']++;
        else if (pnl > 0) pnlRanges['$0-$200']++;
        else if (pnl > -200) pnlRanges['-$200-$0']++;
        else if (pnl > -500) pnlRanges['-$500-$200']++;
        else pnlRanges['<$500']++;
    });

    const pnlOptions = {
        series: [{ data: Object.values(pnlRanges) }],
        chart: {
            type: 'bar',
            height: 300,
            background: 'transparent'
        },
        plotOptions: {
            bar: {
                borderRadius: 6,
                distributed: true
            }
        },
        colors: ['#10b981', '#34d399', '#fbbf24', '#f59e0b', '#ef4444', '#dc2626'],
        xaxis: {
            categories: Object.keys(pnlRanges),
            labels: { style: { colors: '#94a3b8' } }
        },
        yaxis: {
            labels: { style: { colors: '#94a3b8' } }
        }
    };

    if (charts.pnlDist) charts.pnlDist.destroy();
    charts.pnlDist = new ApexCharts(document.querySelector("#pnlDistributionChart"), pnlOptions);
    charts.pnlDist.render();

    // Symbol Performance
    const symbolPnL = {};
    tradesData.forEach(trade => {
        const symbol = trade.symbol?.toUpperCase() || 'Unknown';
        symbolPnL[symbol] = (symbolPnL[symbol] || 0) + (parseFloat(trade.pnl) || 0);
    });

    const sortedSymbols = Object.entries(symbolPnL)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);

    const symbolOptions = {
        series: [{ data: sortedSymbols.map(s => s[1]) }],
        chart: {
            type: 'bar',
            height: 300,
            background: 'transparent'
        },
        plotOptions: {
            bar: {
                borderRadius: 6,
                horizontal: true,
                colors: {
                    ranges: [{
                        from: -999999,
                        to: 0,
                        color: '#ef4444'
                    }, {
                        from: 0,
                        to: 999999,
                        color: '#10b981'
                    }]
                }
            }
        },
        xaxis: {
            categories: sortedSymbols.map(s => s[0]),
            labels: { 
                style: { colors: '#94a3b8' },
                formatter: (val) => '$' + val.toFixed(0)
            }
        }
    };

    if (charts.symbolPerf) charts.symbolPerf.destroy();
    charts.symbolPerf = new ApexCharts(document.querySelector("#symbolPerformanceChart"), symbolOptions);
    charts.symbolPerf.render();

    // Day Performance
    const dayStats = currentLanguage === 'en' 
        ? { 'Mon': {w:0, l:0}, 'Tue': {w:0, l:0}, 'Wed': {w:0, l:0}, 
            'Thu': {w:0, l:0}, 'Fri': {w:0, l:0}, 'Sat': {w:0, l:0}, 'Sun': {w:0, l:0} }
        : { 'Sen': {w:0, l:0}, 'Sel': {w:0, l:0}, 'Rab': {w:0, l:0}, 
            'Kam': {w:0, l:0}, 'Jum': {w:0, l:0}, 'Sab': {w:0, l:0}, 'Min': {w:0, l:0} };
    
    const dayNames = currentLanguage === 'en'
        ? ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
        : ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
    
    tradesData.forEach(trade => {
        const date = new Date(trade.open_date);
        const dayName = dayNames[date.getDay()];
        if (trade.result === 'WIN') dayStats[dayName].w++;
        else if (trade.result === 'LOSS') dayStats[dayName].l++;
    });

    const dayOptions = {
        series: [{
            name: currentLanguage === 'en' ? 'Win' : 'Menang',
            data: Object.values(dayStats).map(d => d.w)
        }, {
            name: currentLanguage === 'en' ? 'Loss' : 'Kalah',
            data: Object.values(dayStats).map(d => d.l)
        }],
        chart: {
            type: 'bar',
            height: 300,
            background: 'transparent',
            stacked: true
        },
        colors: ['#10b981', '#ef4444'],
        xaxis: {
            categories: Object.keys(dayStats),
            labels: { style: { colors: '#94a3b8' } }
        }
    };

    if (charts.dayPerf) charts.dayPerf.destroy();
    charts.dayPerf = new ApexCharts(document.querySelector("#dayPerformanceChart"), dayOptions);
    charts.dayPerf.render();

    // Risk:Reward Analysis
    const rrStats = {};
    tradesData.forEach(trade => {
        const rr = trade.risk_reward || 'Unknown';
        if (!rrStats[rr]) rrStats[rr] = { win: 0, loss: 0, total: 0 };
        rrStats[rr].total++;
        if (trade.result === 'WIN') rrStats[rr].win++;
        else if (trade.result === 'LOSS') rrStats[rr].loss++;
    });

    const rrOptions = {
        series: [{
            name: currentLanguage === 'en' ? 'Win Rate %' : 'Tingkat Menang %',
            data: Object.values(rrStats).map(s => (s.win / s.total * 100).toFixed(1))
        }],
        chart: {
            type: 'bar',
            height: 300,
            background: 'transparent'
        },
        plotOptions: {
            bar: { borderRadius: 6 }
        },
        colors: ['#6366f1'],
        xaxis: {
            categories: Object.keys(rrStats),
            labels: { style: { colors: '#94a3b8' } }
        },
        yaxis: {
            labels: { 
                style: { colors: '#94a3b8' },
                formatter: (val) => val + '%'
            }
        }
    };

    if (charts.rr) charts.rr.destroy();
    charts.rr = new ApexCharts(document.querySelector("#riskRewardChart"), rrOptions);
    charts.rr.render();

    // Equity Curve
    let runningPnL = 0;
    const equityData = [];
    const sortedTrades = [...tradesData].sort((a, b) => 
        new Date(a.open_date) - new Date(b.open_date)
    );
    
    sortedTrades.forEach((trade, index) => {
        runningPnL += parseFloat(trade.pnl) || 0;
        equityData.push({
            x: index + 1,
            y: runningPnL
        });
    });

    const equityOptions = {
        series: [{
            name: currentLanguage === 'en' ? 'Equity' : 'Ekuitas',
            data: equityData.map(d => d.y)
        }],
        chart: {
            type: 'area',
            height: 300,
            background: 'transparent'
        },
        colors: ['#6366f1'],
        fill: {
            type: 'gradient',
            gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.7,
                opacityTo: 0.2
            }
        },
        stroke: { curve: 'smooth', width: 2 },
        xaxis: {
            type: 'numeric',
            labels: { style: { colors: '#94a3b8' } }
        },
        yaxis: {
            labels: { 
                style: { colors: '#94a3b8' },
                formatter: (val) => '$' + val.toFixed(0)
            }
        }
    };

    if (charts.equity) charts.equity.destroy();
    charts.equity = new ApexCharts(document.querySelector("#equityCurveChart"), equityOptions);
    charts.equity.render();

    // Monthly Performance
    const monthlyData = {};
    tradesData.forEach(trade => {
        const date = new Date(trade.open_date);
        const monthKey = date.toLocaleString(currentLanguage === 'en' ? 'en-US' : 'id-ID', { month: 'short' });
        if (!monthlyData[monthKey]) monthlyData[monthKey] = 0;
        monthlyData[monthKey] += parseFloat(trade.pnl) || 0;
    });

    const monthOptions = {
        series: [{ data: Object.values(monthlyData) }],
        chart: {
            type: 'bar',
            height: 300,
            background: 'transparent'
        },
        plotOptions: {
            bar: {
                borderRadius: 6,
                colors: {
                    ranges: [{
                        from: -999999,
                        to: 0,
                        color: '#ef4444'
                    }, {
                        from: 0,
                        to: 999999,
                        color: '#10b981'
                    }]
                }
            }
        },
        xaxis: {
            categories: Object.keys(monthlyData),
            labels: { style: { colors: '#94a3b8' } }
        },
        yaxis: {
            labels: { 
                style: { colors: '#94a3b8' },
                formatter: (val) => '$' + val.toFixed(0)
            }
        }
    };

    if (charts.monthly) charts.monthly.destroy();
    charts.monthly = new ApexCharts(document.querySelector("#monthlyPerformanceChart"), monthOptions);
    charts.monthly.render();
}

function updateCharts() {
    renderOverallStatsChart();
}

// ==========================================
// TRADE TABLE
// ==========================================
function renderTradeTable() {
    const container = document.getElementById('tradeHistoryTable');
    if (!container) return;
    
    if (tradesData.length === 0) {
        const t = translations[currentLanguage];
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-history"></i>
                <h3>${t.noTradeHistory}</h3>
                <p>${t.startJournal}</p>
            </div>
        `;
        return;
    }

    const t = translations[currentLanguage];

    const html = `
        <table class="trade-table">
            <thead>
                <tr>
                    <th>${t.result}</th>
                    <th>${t.symbol}</th>
                    <th>${t.openDate}</th>
                    <th>${t.type}</th>
                    <th>${t.side}</th>
                    <th>TF</th>
                    <th>R:R</th>
                    <th>P&L</th>
                    <th>${currentLanguage === 'en' ? 'Action' : 'Aksi'}</th>
                </tr>
            </thead>
            <tbody>
                ${tradesData.slice(0, 10).map(trade => `
                    <tr>
                        <td>
                            <span class="badge-result badge-${trade.result?.toLowerCase()}">
                                ${trade.result || '-'}
                            </span>
                        </td>
                        <td><strong>${trade.symbol}</strong></td>
                        <td>${formatDate(trade.open_date)}</td>
                        <td>${trade.type || '-'}</td>
                        <td>
                            <span class="badge-side badge-${trade.side || 'buy'}">
                                ${trade.side ? trade.side.toUpperCase() : '-'}
                            </span>
                        </td>
                        <td>${trade.time_frame || '-'}</td>
                        <td>${trade.risk_reward || '-'}</td>
                        <td class="${trade.pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                            ${formatCurrency(trade.pnl)}
                        </td>
                        <td>
                            <div class="action-btns">
                                <button class="btn-action btn-edit" onclick="editTrade('${trade.id}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-action btn-delete" onclick="deleteTrade('${trade.id}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    
    container.innerHTML = html;
}

function filterTrades(searchTerm) {
    const filtered = tradesData.filter(trade => 
        trade.symbol?.toLowerCase().includes(searchTerm) ||
        trade.type?.toLowerCase().includes(searchTerm) ||
        trade.result?.toLowerCase().includes(searchTerm)
    );
    
    const container = document.getElementById('tradeHistoryTable');
    if (!container) return;
    
    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-search"></i>
                <p>${currentLanguage === 'en' ? 'No matching trades found' : 'Tidak ada trading yang cocok'}</p>
            </div>
        `;
        return;
    }
    
    // Store original data temporarily and render filtered
    const originalData = tradesData;
    tradesData = filtered;
    renderTradeTable();
    tradesData = originalData;
}

// ==========================================
// PROJECTS / GOALS
// ==========================================
function renderProjects() {
    const container = document.getElementById('projectsGrid');
    if (!container) return;
    
    if (projectsData.length === 0) {
        const t = translations[currentLanguage];
        container.innerHTML = `
            <div class="empty-state" style="grid-column: 1/-1;">
                <i class="fas fa-bullseye"></i>
                <h3>${currentLanguage === 'en' ? 'No targets yet' : 'Belum ada target'}</h3>
                <p>${currentLanguage === 'en' ? 'Add your trading targets' : 'Tambahkan target trading Anda'}</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = projectsData.map(project => `
        <div class="project-card">
            <div class="project-header">
                <h3>${project.title}</h3>
                <span class="status ${project.status}">${project.status.toUpperCase()}</span>
            </div>
            <p class="project-description">${project.description}</p>
            <div class="project-targets">
                ${(project.targets || []).map((target, idx) => `
                    <div class="target-item" onclick="toggleTarget('${project.id}', ${idx})">
                        <div class="target-checkbox ${target.completed ? 'checked' : ''}">
                            ${target.completed ? '<i class="fas fa-check" style="font-size: 0.7rem;"></i>' : ''}
                        </div>
                        <span class="target-text ${target.completed ? 'completed' : ''}">${target.text}</span>
                    </div>
                `).join('')}
            </div>
            <div class="project-meta">
                <div class="project-progress">
                    <div class="progress-bar">
                        <div class="progress" style="width: ${project.progress}%"></div>
                    </div>
                    <span>${project.progress}%</span>
                </div>
                <button class="btn-action btn-delete" onclick="deleteProject('${project.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
}

async function toggleTarget(projectId, targetIdx) {
    const project = projectsData.find(p => p.id === projectId);
    if (!project || !project.targets) return;
    
    project.targets[targetIdx].completed = !project.targets[targetIdx].completed;
    const completedCount = project.targets.filter(t => t.completed).length;
    project.progress = Math.round((completedCount / project.targets.length) * 100);
    
    try {
        const { error } = await supabaseClient
            .from('projects')
            .update({ 
                targets: project.targets,
                progress: project.progress 
            })
            .eq('id', projectId);
            
        if (error) throw error;
        renderProjects();
    } catch (error) {
        showNotification('Error updating target: ' + error.message, 'error');
    }
}

function openProjectModal() {
    const projectModal = document.getElementById('projectModal');
    const projectForm = document.getElementById('projectForm');
    const targetsContainer = document.getElementById('targetsContainer');
    
    if (projectModal) projectModal.classList.add('active');
    if (projectForm) projectForm.reset();
    if (targetsContainer) {
        targetsContainer.innerHTML = `
            <input type="text" class="target-input" name="target[]" placeholder="Target 1" style="margin-bottom: 0.5rem; width: 100%; padding: 0.8rem; background: var(--glass-bg); border: 2px solid var(--glass-border); border-radius: 8px; color: var(--text-primary);">
        `;
    }
}

function closeProjectModal() {
    const projectModal = document.getElementById('projectModal');
    if (projectModal) projectModal.classList.remove('active');
}

function addTargetInput() {
    const container = document.getElementById('targetsContainer');
    if (!container) return;
    
    const count = container.querySelectorAll('.target-input').length + 1;
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'target-input';
    input.name = 'target[]';
    input.placeholder = `Target ${count}`;
    input.style.cssText = 'margin-bottom: 0.5rem; width: 100%; padding: 0.8rem; background: var(--glass-bg); border: 2px solid var(--glass-border); border-radius: 8px; color: var(--text-primary);';
    container.appendChild(input);
}

async function saveProject(event) {
    event.preventDefault();
    
    const btn = event.target.querySelector('button[type="submit"]');
    if (btn.disabled) return;
    
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<div class="spinner"></div> Saving...';
    btn.disabled = true;
    
    try {
        const title = document.getElementById('projectTitle').value;
        const description = document.getElementById('projectDescription').value;
        
        const targetInputs = document.querySelectorAll('#targetsContainer .target-input');
        const targets = Array.from(targetInputs)
            .map(input => ({ text: input.value, completed: false }))
            .filter(t => t.text.trim() !== '');
        
        const newProject = {
            user_id: currentUser.id,
            title,
            description,
            status: 'active',
            targets: targets.length > 0 ? targets : [{ text: 'Complete project', completed: false }],
            progress: 0
        };
        
        const { data, error } = await supabaseClient
            .from('projects')
            .insert([newProject])
            .select();
            
        if (error) throw error;
        
        projectsData.unshift(data[0]);
        renderProjects();
        closeProjectModal();
        showNotification(translations[currentLanguage].saveTarget + ' ' + (currentLanguage === 'en' ? 'successfully!' : 'berhasil!'), 'success');
        
    } catch (error) {
        console.error('Error saving project:', error);
        showNotification('Error: ' + error.message, 'error');
    } finally {
        btn.innerHTML = originalContent;
        btn.disabled = false;
    }
}

async function deleteProject(id) {
    const t = translations[currentLanguage];
    if (!confirm(currentLanguage === 'en' ? 'Delete this target?' : 'Hapus target ini?')) return;
    
    try {
        const { error } = await supabaseClient
            .from('projects')
            .delete()
            .eq('id', id);
            
        if (error) throw error;
        
        projectsData = projectsData.filter(p => p.id !== id);
        renderProjects();
        showNotification(currentLanguage === 'en' ? 'Target deleted' : 'Target dihapus', 'success');
        
    } catch (error) {
        showNotification('Error: ' + error.message, 'error');
    }
}

// ==========================================
// TRADE MODAL & CRUD
// ==========================================
function openTradeModal(isEdit = false) {
    const tradeModal = document.getElementById('tradeModal');
    const modalTitle = document.getElementById('modalTitle');
    
    if (tradeModal) tradeModal.classList.add('active');
    if (modalTitle) {
        modalTitle.textContent = isEdit ? 
            translations[currentLanguage].addNewTrade.replace('Add New', 'Edit') : 
            translations[currentLanguage].addNewTrade;
    }
    
    if (!isEdit) {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const openDate = document.getElementById('open_date');
        if (openDate) openDate.value = now.toISOString().slice(0, 16);
    }
}

function closeTradeModal() {
    const tradeModal = document.getElementById('tradeModal');
    const tradeForm = document.getElementById('tradeForm');
    
    if (tradeModal) tradeModal.classList.remove('active');
    if (tradeForm) tradeForm.reset();
    currentEditId = null;
}

// ==========================================
// PERBAIKAN: SAVE TRADE dengan support desimal P&L
// ==========================================
async function saveTrade(event) {
    event.preventDefault();
    
    const btn = event.target.querySelector('button[type="submit"]');
    if (btn.disabled) return;
    
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<div class="spinner"></div> Saving...';
    btn.disabled = true;
    
    try {
        const formData = new FormData(event.target);
        const result = formData.get('result');
        
        // PERBAIKAN: Ambil nilai P&L sebagai float dengan presisi desimal
        let pnl = parseFloat(formData.get('pnl')) || 0;
        
        // PERBAIKAN: Logic yang lebih baik untuk handling P&L
        if (result === 'BREAKEVEN') {
            // Jika BREAKEVEN, force ke 0
            pnl = 0;
        } else if (result === 'WIN') {
            // WIN harus positif, tapi tetap pertahankan nilai desimal
            if (pnl < 0) {
                pnl = Math.abs(pnl);
            }
            // Jika sudah positif (termasuk desimal seperti 0.30), biarkan apa adanya
        } else if (result === 'LOSS') {
            // LOSS harus negatif, tapi tetap pertahankan nilai desimal
            if (pnl > 0) {
                pnl = -Math.abs(pnl);
            }
            // Jika sudah negatif (termasuk desimal seperti -0.30), biarkan apa adanya
        }
        
        // Debug log untuk memastikan nilai desimal tersimpan
        console.log('Saving P&L:', pnl, 'Type:', typeof pnl);
        
        const tradeData = {
            user_id: currentUser.id,
            result: result,
            symbol: formData.get('symbol').toUpperCase(),
            open_date: formData.get('open_date'),
            type: formData.get('type'),
            side: formData.get('side'),
            time_frame: formData.get('time_frame') || null,
            risk_reward: formData.get('risk_reward') || null,
            pnl: pnl,  // Nilai desimal seperti 0.30 akan tersimpan dengan benar
            image_before: formData.get('image_before') || null,
            image_after: formData.get('image_after') || null,
            note: formData.get('note') || null
        };

        if (currentEditId) {
            const { data, error } = await supabaseClient
                .from('trades')
                .update(tradeData)
                .eq('id', currentEditId)
                .select();
                
            if (error) throw error;
            
            const index = tradesData.findIndex(t => t.id === currentEditId);
            if (index !== -1) tradesData[index] = data[0];
            
            showNotification(translations[currentLanguage].saveTrade + ' ' + (currentLanguage === 'en' ? 'successfully!' : 'berhasil!'), 'success');
        } else {
            const { data, error } = await supabaseClient
                .from('trades')
                .insert([tradeData])
                .select();
                
            if (error) throw error;
        }

        closeTradeModal();
        updateStats();
        renderCharts();
        renderTradeTable();
        renderCalendar();
        
    } catch (error) {
        console.error('Error saving trade:', error);
        showNotification('Error: ' + error.message, 'error');
    } finally {
        btn.innerHTML = originalContent;
        btn.disabled = false;
    }
}

async function editTrade(id) {
    const trade = tradesData.find(t => t.id === id);
    if (!trade) return;

    currentEditId = id;
    
    document.getElementById('result').value = trade.result || '';
    document.getElementById('symbol').value = trade.symbol || '';
    document.getElementById('open_date').value = trade.open_date ? trade.open_date.slice(0, 16) : '';
    document.getElementById('type').value = trade.type || '';
    document.getElementById('side').value = trade.side || '';
    document.getElementById('time_frame').value = trade.time_frame || '';
    document.getElementById('risk_reward').value = trade.risk_reward || '';
    
    // PERBAIKAN: Set nilai P&L dengan format yang benar (termasuk desimal)
    const pnlValue = trade.pnl !== null && trade.pnl !== undefined ? parseFloat(trade.pnl) : '';
    document.getElementById('pnl').value = pnlValue;
    
    document.getElementById('image_before').value = trade.image_before || '';
    document.getElementById('image_after').value = trade.image_after || '';
    document.getElementById('note').value = trade.note || '';

    openTradeModal(true);
}

async function deleteTrade(id) {
    const t = translations[currentLanguage];
    if (!confirm(currentLanguage === 'en' ? 'Delete this trade?' : 'Hapus trading ini?')) return;
    
    try {
        const { error } = await supabaseClient
            .from('trades')
            .delete()
            .eq('id', id);
            
        if (error) throw error;
        
        tradesData = tradesData.filter(t => t.id !== id);
        updateStats();
        renderCharts();
        renderTradeTable();
        renderCalendar();
        showNotification(currentLanguage === 'en' ? 'Trade deleted' : 'Trading dihapus', 'success');
        
    } catch (error) {
        showNotification('Error: ' + error.message, 'error');
    }
}

// ==========================================
// NAVIGATION & UI
// ==========================================
function switchSection(section, contentId) {
    document.querySelectorAll('.content-section').forEach(content => {
        content.classList.remove('active');
    });
    const targetContent = document.getElementById(contentId);
    if (targetContent) targetContent.classList.add('active');
    
    document.querySelectorAll('.nav-links li').forEach(li => {
        li.classList.remove('active');
        if (li.dataset.section === section) {
            li.classList.add('active');
        }
    });

    const profileDropdown = document.getElementById('profileDropdown');
    if (profileDropdown) profileDropdown.classList.remove('active');
}

function toggleProfile() {
    const profileDropdown = document.getElementById('profileDropdown');
    if (profileDropdown) {
        profileDropdown.classList.toggle('active');
    }
}

function toggleTheme() {
    const html = document.documentElement;
    const isDark = html.classList.contains('dark-theme');
    
    if (isDark) {
        html.classList.replace('dark-theme', 'light-theme');
    } else {
        html.classList.replace('light-theme', 'dark-theme');
    }
    
    updateChartsTheme();
}

function updateChartsTheme() {
    const isDark = document.documentElement.classList.contains('dark-theme');
    const theme = isDark ? 'dark' : 'light';
    
    Object.values(charts).forEach(chart => {
        if (chart) {
            chart.updateOptions({
                theme: { mode: theme },
                chart: {
                    background: 'transparent'
                }
            });
        }
    });
}

// ==========================================
// PERBAIKAN: UTILITY FUNCTIONS untuk format currency dengan desimal
// ==========================================
function formatCurrency(value) {
    if (value === null || value === undefined) return '-';
    const num = parseFloat(value);
    
    // PERBAIKAN: Tentukan jumlah desimal berdasarkan nilai
    // Jika nilai memiliki desimal, tampilkan 2 desimal
    // Jika nilai bulat, tampilkan tanpa desimal kecuali nilai kecil (< 10)
    const hasDecimal = num % 1 !== 0;
    const fractionDigits = hasDecimal ? 2 : (Math.abs(num) < 10 ? 2 : 0);
    
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: fractionDigits,
        maximumFractionDigits: 2  // Selalu izinkan sampai 2 desimal
    }).format(num);
}

function formatCurrencyShort(value) {
    const num = parseFloat(value);
    if (Math.abs(num) >= 1000) return (num / 1000).toFixed(1) + 'k';
    // PERBAIKAN: Untuk nilai kecil dengan desimal, tampilkan 2 desimal
    if (Math.abs(num) < 1 && num !== 0) return num.toFixed(2); // 0.30 tetap 0.30
    if (Math.abs(num) < 10 && num % 1 !== 0) return num.toFixed(2); // 1.50 tetap 1.50
    return num.toFixed(num % 1 === 0 ? 0 : 1); // 10.5 jadi 10.5, 10 jadi 10
}

function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'id-ID', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
    });
}

function formatTime(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleTimeString(currentLanguage === 'en' ? 'en-US' : 'id-ID', {
        hour: '2-digit',
        minute: '2-digit'
    });
}

function showNotification(message, type = 'success') {
    const container = document.getElementById('notification-container');
    if (!container) return;
    
    const notification = document.createElement('div');
    notification.className = `custom-notification ${type}`;
    
    const icon = type === 'success' ? 'check-circle' : 
                type === 'error' ? 'times-circle' : 'info-circle';
    
    notification.innerHTML = `
        <i class="fas fa-${icon}"></i>
        <div class="notification-content">
            <p>${message}</p>
        </div>
    `;

    container.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// ==========================================
// APP SWITCHING & AUTH
// ==========================================
function switchApp() {
    window.location.href = 'budget.html';
}

async function logout() {
    try {
        const { error } = await supabaseClient.auth.signOut();
        if (error) throw error;
        
        showNotification(currentLanguage === 'en' ? 'Logged out successfully!' : 'Berhasil keluar!', 'success');
        setTimeout(() => {
            window.location.href = 'index.html';
        }, 1000);
    } catch (error) {
        console.error('Logout error:', error);
        showNotification('Error logging out: ' + error.message, 'error');
    }
}
    </script>
</body>

</html>
